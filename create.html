<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Your Athlete</title>
  <style>
    :root{
      --bg:#0e0f12;--card:#151821;--muted:#9aa3b2;--text:#e9eef7;
      --accent:#5eead4;--accent2:#60a5fa;--ring:rgba(94,234,212,.5);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 600px at 50% -10%, #121521, var(--bg));color:var(--text)
    }
    header{
      position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;background:linear-gradient(to bottom, rgba(21,24,33,.9), rgba(21,24,33,.6));
      backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .logo{width:28px;height:28px;display:grid;place-items:center;border-radius:8px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1020}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:linear-gradient(145deg, rgba(21,24,33,.9), rgba(21,24,33,.65));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media(max-width:900px){.row{grid-template-columns:1fr;}}
    .pad{padding:16px}
    .tools{display:flex;flex-wrap:wrap;gap:8px}
    button,select,input[type="range"],input[type="file"]{
      appearance:none;background:#1a1f2b;border:1px solid rgba(255,255,255,.08);color:var(--text);
      padding:8px 10px;border-radius:10px
    }
    button:hover{background:#1f2533}
    .hint{color:var(--muted);font-size:.95rem}
    .steps{display:flex;gap:8px;flex-wrap:wrap}
    .step{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#111522;color:var(--muted)}
    .step.active{color:var(--text);outline:2px solid var(--ring)}
    .ghost-toggle{display:flex;align-items:center;gap:8px}
    .footer{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
    canvas{
      background:#0f1219;border:1px solid rgba(255,255,255,.08);border-radius:14px;width:100%;height:auto;
      touch-action:none;-ms-touch-action:none;
    }
    .preview{min-height:260px;display:grid;place-items:center}
    .warn{color:#fca5a5}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">VB</div><div>Create Your Athlete</div></div>
    <a href="./index.html" style="color:var(--text);text-decoration:none">◀ Home</a>
  </header>

  <main>
    <section class="card pad">
      <div class="steps" id="steps"></div>
      <h2 id="title" style="margin:10px 0 6px">Design: Head</h2>
      <p class="hint">Template shows behind your drawing. Toggle “Show guide” to hide/show. Draw, then <b>Save Part</b> and <b>Next</b>.</p>

      <div class="row">
        <div class="pad" style="padding:0">
          <canvas id="draw" width="720" height="720" aria-label="Drawing canvas"></canvas>

          <div class="pad" style="display:flex;flex-wrap:wrap;align-items:center;gap:10px">
            <div class="tools">
              <label>Brush: <input type="range" id="brush" min="1" max="40" value="8"></label>
              <label>Opacity: <input type="range" id="opacity" min="10" max="100" value="100"></label>
              <label>Color: <input type="color" id="color" value="#60a5fa"></label>
              <button id="undo">Undo</button>
              <button id="clear">Clear</button>
            </div>
            <div class="ghost-toggle">
              <input type="checkbox" id="ghostToggle" checked>
              <label for="ghostToggle">Show guide</label>
            </div>
            <div class="tools">
              <input id="guideUpload" type="file" accept="image/*">
              <button id="removeGuide">Hide template</button>
            </div>
          </div>
        </div>

        <div class="pad" style="display:grid;gap:12px">
          <div class="card pad preview">
            <canvas id="preview" width="280" height="280" aria-label="Preview"></canvas>
          </div>
          <div id="warn" class="hint warn"></div>
          <div class="hint">Saved parts are stored locally on your phone under <code>vbgame.characterArt.v1</code>.</div>

          <div class="footer">
            <div>
              <button id="savePart">Save Part</button>
              <span id="saveStatus" class="hint"></span>
            </div>
            <div>
              <button id="back">◀ Back</button>
              <button id="next">Next ▶</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card pad">
      <h3>Tips</h3>
      <ul>
        <li>Keep strokes inside the template for easy rigging later.</li>
        <li>Use simple shapes; this will be a cut-out puppet.</li>
        <li>Tap the chips at the top to jump between parts.</li>
      </ul>
    </section>
  </main>

<script>
/* -------- PARTS: matches your filenames exactly -------- */
const PARTS = [
  { id:'head',     title:'Head',     guidePath:'assets/guides/head.png' },
  { id:'torso',    title:'Torso',    guidePath:'assets/guides/torso.png' },
  { id:'leftarm',  title:'Left Arm', guidePath:'assets/guides/leftarm.png' },
  { id:'rightarm', title:'Right Arm',guidePath:'assets/guides/rightarm.png' },
  { id:'shorts',   title:'Shorts',   guidePath:'assets/guides/shorts.png' },
  { id:'leftleg',  title:'Left Leg', guidePath:'assets/guides/leftleg.png' },
  { id:'rightleg', title:'Right Leg',guidePath:'assets/guides/rightleg.png' }
];

const KEY_STORE = 'vbgame.characterArt.v1';
const S = JSON.parse(localStorage.getItem(KEY_STORE) || '{}');

let idx = PARTS.findIndex(p => !S[p.id]);
if (idx === -1) idx = 0;

/* -------- UI refs -------- */
const stepsEl = document.getElementById('steps');
const titleEl = document.getElementById('title');
const saveStatus = document.getElementById('saveStatus');
const warnEl = document.getElementById('warn');
const brushEl = document.getElementById('brush');
const opacityEl = document.getElementById('opacity');
const colorEl = document.getElementById('color');
const guideUpload = document.getElementById('guideUpload');
const ghostToggle = document.getElementById('ghostToggle');

/* -------- Fabric setup -------- */
const canvas = new fabric.Canvas('draw', { isDrawingMode: true, backgroundColor: 'transparent' });
const preview = new fabric.StaticCanvas('preview');
let ghostLayer = null;

/* -------- Helpers -------- */
function cacheBust(url){ const v = Date.now().toString().slice(-6); return url + (url.includes('?') ? '&' : '?') + 'v=' + v; }

function report(msg){
  warnEl.textContent = msg || '';
}

/* -------- Steps chips -------- */
function renderSteps(){
  stepsEl.innerHTML = '';
  PARTS.forEach((p, i)=>{
    const chip = document.createElement('div');
    chip.className = 'step' + (i===idx ? ' active' : '');
    chip.textContent = (i+1)+'. '+p.title + (S[p.id] ? ' ✓' : '');
    chip.style.cursor = 'pointer';
    chip.addEventListener('click', ()=>{ idx = i; loadPart(); });
    stepsEl.appendChild(chip);
  });
}

/* -------- Controls -------- */
brushEl.addEventListener('input', ()=>{ canvas.freeDrawingBrush.width = +brushEl.value; });
opacityEl.addEventListener('input', ()=>{ canvas.freeDrawingBrush.opacity = (+opacityEl.value)/100; });
colorEl.addEventListener('input', ()=>{ canvas.freeDrawingBrush.color = colorEl.value; });

document.getElementById('undo').addEventListener('click', ()=>{
  const objs = canvas.getObjects().filter(o => o !== ghostLayer);
  if (!objs.length) return;
  canvas.remove(objs[objs.length-1]); canvas.requestRenderAll(); updatePreview();
});

document.getElementById('clear').addEventListener('click', ()=>{
  canvas.getObjects().slice().forEach(o => { if (o !== ghostLayer) canvas.remove(o); });
  canvas.requestRenderAll(); updatePreview();
});

document.getElementById('removeGuide').addEventListener('click', ()=>{
  if (ghostLayer){ canvas.remove(ghostLayer); ghostLayer = null; canvas.requestRenderAll(); }
});

ghostToggle.addEventListener('change', (e)=>{
  if (e.target.checked){
    if (!ghostLayer){ // (re)load default guide for this step
      const url = PARTS[idx].guidePath;
      if (url) loadGuideImage(url);
    } else {
      ghostLayer.visible = true; canvas.requestRenderAll();
    }
  } else {
    if (ghostLayer){ ghostLayer.visible = false; canvas.requestRenderAll(); }
  }
});

/* Upload a custom guide image */
guideUpload.addEventListener('change', (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ()=> loadGuideImage(reader.result);
  reader.readAsDataURL(file);
});

/* -------- Guide loader (with errors shown) -------- */
function loadGuideImage(src){
  if (!src) return;
  if (ghostLayer){ canvas.remove(ghostLayer); ghostLayer = null; }
  const url = src.startsWith('data:') ? src : cacheBust(src);

  fabric.util.loadImage(url,
    (imgElem)=>{
      if (!imgElem){ report('Guide failed to decode.'); return; }
      const img = new fabric.Image(imgElem, { selectable:false, evented:false, opacity:0.45 });
      const max = 640;
      const scale = Math.min(max / img.width, max / img.height, 1);
      img.set({
        left:(720 - img.width*scale)/2,
        top:(720 - img.height*scale)/2,
        scaleX:scale, scaleY:scale,
      });
      ghostLayer = img;
      canvas.add(img);
      img.sendToBack();
      canvas.requestRenderAll();
      report('');
    },
    { crossOrigin:'anonymous' }
  );
}

/* -------- Load a part -------- */
function loadPart(){
  renderSteps();
  saveStatus.textContent = '';
  report('');
  titleEl.textContent = 'Design: ' + PARTS[idx].title;

  // Reset canvas and brush
  canvas.clear();
  canvas.setBackgroundColor('transparent', canvas.renderAll.bind(canvas));
  canvas.isDrawingMode = true;
  canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
  canvas.freeDrawingBrush.width = +brushEl.value;
  canvas.freeDrawingBrush.color = colorEl.value;
  canvas.freeDrawingBrush.opacity = (+opacityEl.value)/100;

  // Auto-load default guide if toggle is on
  if (ghostToggle.checked && PARTS[idx].guidePath){
    loadGuideImage(PARTS[idx].guidePath);
  }

  // If saved drawing exists, layer it (under the guide)
  const savedUrl = S[PARTS[idx].id];
  if (savedUrl){
    fabric.Image.fromURL(savedUrl, img=>{
      img.set({ left:0, top:0, selectable:false, evented:false });
      canvas.add(img);
      if (ghostLayer) ghostLayer.bringToFront();
      canvas.requestRenderAll();
    }, {crossOrigin:'anonymous'});
  }

  updatePreview();
}

/* -------- Preview exporter -------- */
function updatePreview(){
  const url = canvas.toDataURL({ format:'png', enableRetinaScaling:false, multiplier:1, withoutTransform:true });
  preview.clear();
  fabric.Image.fromURL(url, img=>{
    img.set({ left:20, top:20, scaleX:240/720, scaleY:240/720, selectable:false, evented:false });
    preview.add(img);
  });
}
canvas.on('after:render', ()=>{
  if (updatePreview._t) cancelAnimationFrame(updatePreview._t);
  updatePreview._t = requestAnimationFrame(updatePreview);
});

/* -------- Save -------- */
function saveCurrent(){
  const url = canvas.toDataURL({ format:'png', enableRetinaScaling:false, multiplier:1, withoutTransform:true });
  const id = PARTS[idx].id;
  S[id] = url;
  localStorage.setItem(KEY_STORE, JSON.stringify(S));
  saveStatus.textContent = `Saved ${PARTS[idx].title} ✓`;
  renderSteps();
}
document.getElementById('savePart').addEventListener('click', saveCurrent);

/* -------- Navigation -------- */
document.getElementById('next').addEventListener('click', ()=>{
  if (!S[PARTS[idx].id]){ report('Please Save Part before continuing.'); return; }
  if (idx < PARTS.length-1){ idx++; loadPart(); }
  else { window.location.href = 'index.html'; }
});
document.getElementById('back').addEventListener('click', ()=>{
  if (idx>0){ idx--; loadPart(); } else { window.location.href = 'index.html'; }
});

/* -------- Boot -------- */
renderSteps();
loadPart();
</script>
</body>
</html>
