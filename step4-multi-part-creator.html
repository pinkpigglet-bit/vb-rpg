<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Step 4 — Multi-Part Creator (Persist + Save All + Show Guide Fix)</title>
<style>
  body{margin:0;background:#0e0f12;color:#e9eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  main{max-width:1000px;margin:0 auto;padding:16px}
  h1{margin:8px 0 12px;font-size:18px}
  .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media(max-width:1000px){.row{grid-template-columns:1fr}}
  canvas{
    display:block;width:100%;max-width:720px;height:auto;
    background:#0f1219;border:1px solid rgba(255,255,255,.12);border-radius:12px;
    touch-action:none;-ms-touch-action:none;
  }
  .panel{background:#151821;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
  .muted{color:#9aa3b2}
  .ok{color:#5eead4}.warn{color:#fca5a5}

  /* fixed: remove checkbox from the generic input group */
  button,input[type="range"],input[type="color"],input[type="file"],select{
    appearance:none;background:#1a1f2b;color:#e9eef7;
    border:1px solid rgba(255,255,255,.12);
    padding:8px 10px;border-radius:10px;margin-right:8px
  }

  /* clickable checkboxes */
  input[type="checkbox"]{
    appearance:auto;
    width:20px;height:20px;
    cursor:pointer;
    accent-color:#5eead4;
  }
  label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
</style>
</head>
<body>
<main>
  <h1>Step 4 — Multi-Part Creator (Persist per Part + Save All + Show Guide Fix)</h1>
  <p class="muted">
    Draw each part and switch freely — work is preserved per part.<br>
    <b>Save Part</b> overwrites one, <b>Save All</b> overwrites every part in <code>localStorage</code>.
  </p>

  <div class="panel" style="margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:center;gap:8px">
    <label>Part
      <select id="part">
        <option value="head">Head</option>
        <option value="torso">Torso</option>
        <option value="leftarm">Left Arm</option>
        <option value="rightarm">Right Arm</option>
        <option value="shorts">Shorts</option>
        <option value="leftleg">Left Leg</option>
        <option value="rightleg">Right Leg</option>
      </select>
    </label>
    <button id="saveAll">Save All</button>
    <span id="status" class="muted">Status: ready</span>
  </div>

  <div class="row">
    <div class="panel">
      <canvas id="c" width="720" height="720"></canvas>

      <div class="controls">
        <label>Brush <input id="w" type="range" min="1" max="40" value="8"></label>
        <label>Opacity <input id="o" type="range" min="10" max="100" value="100"></label>
        <label>Color <input id="col" type="color" value="#60a5fa"></label>
        <label><input id="show" type="checkbox" checked> Show guide</label>
        <input id="upload" type="file" accept="image/*">
        <button id="remove">Remove guide</button>
        <button id="clear">Clear (session)</button>
        <button id="reset">Reset Part</button>
        <button id="save">Save Part</button>
      </div>
    </div>

    <div class="panel">
      <p class="muted">
        Base guide path: <code>assets/guides/&lt;part&gt;.png</code><br>
        • Upload = override base guide • Remove = revert to base<br>
        • Clear = session only • Reset Part = delete saved PNG<br>
        • Save All = overwrite every part in <code>localStorage</code>
      </p>
    </div>
  </div>
</main>

<script>
const STORE_KEY='vbgame.characterArt.v1';
const PARTS=['head','torso','leftarm','rightarm','shorts','leftleg','rightleg'];

const partEl=document.getElementById('part');
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const statusEl=document.getElementById('status');
const showEl=document.getElementById('show');
const uploadEl=document.getElementById('upload');
const removeEl=document.getElementById('remove');
const clearBtn=document.getElementById('clear');
const resetBtn=document.getElementById('reset');
const saveBtn=document.getElementById('save');
const saveAllBtn=document.getElementById('saveAll');
const w=document.getElementById('w');
const o=document.getElementById('o');
const col=document.getElementById('col');

let currentPart=partEl.value;
const state={};
function ensureState(p){if(!state[p])state[p]={strokes:[],customGuideDataUrl:null};return state[p];}

let baseGuideImg=null,customGuideImg=null,guideImg=null,savedArtImg=null;
let drawing=false,lastX=0,lastY=0,currentStroke=null;

function setStatus(t,cls='muted'){statusEl.className=cls;statusEl.textContent='Status: '+t;}
function cacheBust(u){return u+(u.includes('?')?'&':'?')+'v='+Date.now().toString().slice(-6);}
function hexToRgba(h,a){const v=h.replace('#','');const r=parseInt(v.substring(0,2),16);
 const g=parseInt(v.substring(2,4),16);const b=parseInt(v.substring(4,6),16);
 return`rgba(${r},${g},${b},${a})`; }
function getPos(e){const r=canvas.getBoundingClientRect();const t=('touches'in e)?e.touches[0]:
 ('changedTouches'in e?e.changedTouches[0]:e);
 return{x:(t.clientX-r.left)*(canvas.width/r.width),y:(t.clientY-r.top)*(canvas.height/r.height)};}

function drawImageCentered(img,a=1){const max=640;const s=Math.min(max/img.width,max/img.height,1);
 const w2=img.width*s,h2=img.height*s,x=(canvas.width-w2)/2,y=(canvas.height-h2)/2;
 ctx.globalAlpha=a;ctx.drawImage(img,x,y,w2,h2);ctx.globalAlpha=1;}
function drawGuide(){if(!guideImg||!showEl.checked)return;drawImageCentered(guideImg,0.45);}
function drawSavedArt(){if(savedArtImg)drawImageCentered(savedArtImg,1);}
function drawStroke(st){ctx.lineCap='round';ctx.lineJoin='round';ctx.lineWidth=st.width;
 ctx.strokeStyle=hexToRgba(st.color,st.alpha);ctx.beginPath();
 st.points.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));ctx.stroke();}
function drawAll(){ctx.clearRect(0,0,canvas.width,canvas.height);
 drawGuide();drawSavedArt();
 ensureState(currentPart).strokes.forEach(drawStroke);
 if(currentStroke)drawStroke(currentStroke);}

function start(e){e.preventDefault();drawing=true;const p=getPos(e);lastX=p.x;lastY=p.y;
 currentStroke={color:col.value,alpha:(+o.value)/100,width:+w.value,points:[p]};
 setStatus(`drawing ${currentPart}…`);}
function move(e){if(!drawing)return;e.preventDefault();
 const p=getPos(e);currentStroke.points.push(p);drawAll();lastX=p.x;lastY=p.y;}
function end(e){if(!drawing)return;e.preventDefault();drawing=false;
 ensureState(currentPart).strokes.push(currentStroke);currentStroke=null;drawAll();setStatus('stroke committed ✓','ok');}

canvas.addEventListener('pointerdown',start,{passive:false});
canvas.addEventListener('pointermove',move,{passive:false});
canvas.addEventListener('pointerup',end,{passive:false});
canvas.addEventListener('pointercancel',end,{passive:false});
canvas.addEventListener('touchstart',start,{passive:false});
canvas.addEventListener('touchmove',move,{passive:false});
canvas.addEventListener('touchend',end,{passive:false});

[w,o,col,showEl].forEach(el=>el.addEventListener('input',drawAll));
clearBtn.addEventListener('click',()=>{ensureState(currentPart).strokes=[];currentStroke=null;drawAll();setStatus(`cleared session for ${currentPart}`);});

async function exportPNGWithoutGuide(p,includeCurrent=true){
 const off=document.createElement('canvas');off.width=canvas.width;off.height=canvas.height;const oc=off.getContext('2d');
 let savedUrl=null;try{const s=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');savedUrl=s[p];}catch{}
 const st=state[p]||{strokes:[]};
 if(savedUrl){await new Promise(res=>{const img=new Image();img.onload=()=>{drawImageCentered.call({ctx:oc},img);res();};
 img.onerror=res;img.src=savedUrl;});}
 st.strokes.forEach(s=>{oc.lineCap='round';oc.lineJoin='round';oc.lineWidth=s.width;
  oc.strokeStyle=hexToRgba(s.color,s.alpha);oc.beginPath();
  s.points.forEach((pt,i)=>i?oc.lineTo(pt.x,pt.y):oc.moveTo(pt.x,pt.y));oc.stroke();});
 if(includeCurrent&&p===currentPart&&currentStroke){
  const s=currentStroke;oc.lineCap='round';oc.lineJoin='round';oc.lineWidth=s.width;
  oc.strokeStyle=hexToRgba(s.color,s.alpha);oc.beginPath();
  s.points.forEach((pt,i)=>i?oc.lineTo(pt.x,pt.y):oc.moveTo(pt.x,pt.y));oc.stroke();}
 return off.toDataURL('image/png');
}
function saveToLocalStorage(p,d){try{const s=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');s[p]=d;
 localStorage.setItem(STORE_KEY,JSON.stringify(s));return true;}catch{return false;}}
saveBtn.addEventListener('click',async()=>{const d=await exportPNGWithoutGuide(currentPart,true);
 const ok=saveToLocalStorage(currentPart,d);const img=new Image();img.onload=()=>{savedArtImg=img;
 ensureState(currentPart).strokes=[];currentStroke=null;drawAll();setStatus((ok?`saved ${currentPart} ✓`:'save failed'),'ok');};img.src=d;});
saveAllBtn.addEventListener('click',async()=>{setStatus('saving all…');for(const p of PARTS){
 const d=await exportPNGWithoutGuide(p,p===currentPart);saveToLocalStorage(p,d);
 if(p===currentPart){const img=new Image();img.onload=()=>{savedArtImg=img;ensureState(p).strokes=[];currentStroke=null;drawAll();};img.src=d;}}
 setStatus('saved all parts ✓','ok');});

uploadEl.addEventListener('change',e=>{
 const f=e.target.files?.[0];if(!f)return;const r=new FileReader();
 r.onload=()=>{ensureState(currentPart).customGuideDataUrl=r.result;const img=new Image();
 img.onload=()=>{customGuideImg=img;guideImg=customGuideImg||baseGuideImg;drawAll();setStatus('custom guide ✓','ok');};
 img.onerror=()=>setStatus('decode fail','warn');img.src=r.result;};r.readAsDataURL(f);});
removeEl.addEventListener('click',()=>{ensureState(currentPart).customGuideDataUrl=null;
 customGuideImg=null;guideImg=baseGuideImg;drawAll();setStatus('reverted to base ✓','ok');});

function loadBaseGuide(p,cb){baseGuideImg=null;guideImg=null;
 const img=new Image();img.crossOrigin='anonymous';img.src=cacheBust(`assets/guides/${p}.png`);
 img.onload=()=>{baseGuideImg=img;const cu=ensureState(p).customGuideDataUrl;
  if(cu){const ci=new Image();ci.onload=()=>{customGuideImg=ci;guideImg=customGuideImg||baseGuideImg;cb&&cb();};
   ci.onerror=()=>{customGuideImg=null;guideImg=baseGuideImg;cb&&cb();};ci.src=cu;}
  else{customGuideImg=null;guideImg=baseGuideImg;cb&&cb();}};
 img.onerror=()=>{setStatus(`fail guide ${p}`,'warn');cb&&cb();};}
function loadSavedArt(p,cb){savedArtImg=null;
 try{const s=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');const u=s[p];if(!u){cb&&cb();return;}
 const i=new Image();i.onload=()=>{savedArtImg=i;cb&&cb();};i.onerror=()=>cb&&cb();i.src=u;}
 catch(e){cb&&cb();}}
function loadPart(p){setStatus(`loading ${p}…`);
 if(currentStroke){ensureState(currentPart).strokes.push(currentStroke);currentStroke=null;}
 currentPart=p;
 loadBaseGuide(p,()=>loadSavedArt(p,()=>{drawAll();setStatus(`${p} ready ✓`,'ok');}));}
partEl.addEventListener('change',()=>loadPart(partEl.value));
resetBtn.addEventListener('click',()=>{try{const s=JSON.parse(localStorage.getItem(STORE_KEY)||'{}');
 delete s[currentPart];localStorage.setItem(STORE_KEY,JSON.stringify(s));}catch{}
 savedArtImg=null;ensureState(currentPart).strokes=[];currentStroke=null;drawAll();
 setStatus(`cleared ${currentPart} ✓`,'ok');});
loadPart(currentPart);
setStatus('ready');
</script>
</body>
</html>
